\RequirePackage{iftex}
%% Разрешить компиляцию только с движком LuaTex
\makeatletter
\ifLuaTeX
\else
    \newlinechar 64\relax
    \errorcontextlines -1\relax
    \immediate\write20{@
        ************************************************@
        * LuaLaTex is required to compile this document.@
        * Sorry!@
        ************************************************}%
    \batchmode\read -1 to \@tempa
\fi
\makeatother

%% Для русификации достаточно подключить пакет fontspec и
%% выбрать Unicode шрифт в котором есть кириллические глифы. Ниже
%% основным шрифтом выбирается Unicode версия шрифта Computer Modern с заcечками
\RequirePackage{fontspec}
\setmainfont{CMU Serif}
\setsansfont{CMU Sans Serif}
\setmonofont{CMU Typewriter Text}

%% В LuaLaTeX альтернативой известного пакета babel является пакет polyglossia.
%% Теперь у нас будут переносы слов
\RequirePackage{polyglossia}
\setdefaultlanguage{russian}
\setotherlanguage{english}

\RequirePackage{lineno}
\RequirePackage[autostyle]{csquotes} % Правильные кавычки в зависимости от языка

% ToDo:
% [] MathNote   : \tikzmatrix 
% [] MathNote   : smashable \sum* commands
% [] Layout     : Define colors
% [] Fix hidding enviroment

%Отключить предупреждения об кастномной использовании пакетов "You have requested package..."
%\usepackage{silence}
%\WarningFilter{latex}{You have requested package}

\RequirePackage{xparse}
\RequirePackage{luacode}

%% Macroses for manipulation lua booleans in xparse-style
\RequirePackage{tooling/luaboolean}

%%% Load configuration
\directlua{configuration = require('tooling/lua/loader').load('tooling/lua/configuration')}

%%% Load custom macroses
\IfLuaBooleanT{configuration.mathematics.enable}{
  \RequirePackage{macroses/mathematics}
}
\IfLuaBooleanT{configuration.typesetting.enable}{
  \RequirePackage{macroses/typesetting}
}
\IfLuaBooleanT{configuration.floats.enable}{
  \RequirePackage{macroses/floats}
}
\IfLuaBooleanT{configuration.references.enable}{
  \RequirePackage[hyperref, citations, indexes]{macroses/references}
}

%\PreambleLoadPackages
%\PreambleDeclareMacroses

% \sloppy
